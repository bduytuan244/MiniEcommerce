<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω ƒê∆°n h√†ng - Admin</title>
    <style>
        body { margin: 0; font-family: Arial, sans-serif; display: flex; height: 100vh; background: #f4f6f9; }
        .sidebar { width: 250px; background: #343a40; color: white; display: flex; flex-direction: column; }
        .sidebar h2 { text-align: center; padding: 20px 0; margin: 0; background: #23272b; border-bottom: 1px solid #4f5962; }
        .menu { list-style: none; padding: 0; margin: 0; flex: 1; }
        .menu li { border-bottom: 1px solid #4f5962; }
        .menu a { display: block; padding: 15px 20px; color: #c2c7d0; text-decoration: none; transition: 0.3s; }
        .menu a:hover, .menu a.active { background: #007bff; color: white; }
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .content { padding: 30px; overflow-y: auto; flex: 1; }
        .sidebar .logout-btn { padding: 15px; background: #dc3545; color: white; text-align: center; cursor: pointer; }

        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #17a2b8; color: white; }
        tr:hover { background: #f1f1f1; }

        .badge { padding: 5px 10px; border-radius: 4px; color: white; font-size: 0.8em; font-weight: bold; }
        .bg-pending { background: #ffc107; color: #333; } 
        .bg-processing { background: #17a2b8; } 
        .bg-shipped { background: #007bff; } 
        .bg-delivered { background: #28a745; } 
        .bg-cancelled { background: #dc3545; } 

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 20px; border-radius: 8px; width: 600px; max-width: 90%; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; border-bottom: 1px solid #ddd; padding-bottom: 10px; margin-bottom: 15px; }
        .btn-update { background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; width: 100%; margin-top: 10px; font-weight: bold; }
        .btn-update:hover { background: #218838; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2>MINI ADMIN</h2>
        <ul class="menu">
            <li><a href="index.html">T·ªïng quan</a></li>
            <li><a href="products.html">Qu·∫£n l√Ω S·∫£n ph·∫©m</a></li>
            <li><a href="orders.html" class="active">Qu·∫£n l√Ω ƒê∆°n h√†ng</a></li>
            <li><a href="users.html">Qu·∫£n l√Ω Ng∆∞·ªùi d√πng</a></li>
        </ul>
        <div class="logout-btn" onclick="logout()">üö™ ƒêƒÉng xu·∫•t</div>
    </div>

    <div class="main-content">
        <div class="content">
            <h2 style="margin-top: 0;">Danh s√°ch ƒê∆°n h√†ng</h2>
            <table>
                <thead>
                    <tr>
                        <th>M√£ ƒê∆°n</th>
                        <th>Kh√°ch h√†ng</th>
                        <th>Ng√†y ƒë·∫∑t</th>
                        <th>T·ªïng ti·ªÅn</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th>H√†nh ƒë·ªông</th>
                    </tr>
                </thead>
                <tbody id="order-table-body">
                    <tr><td colspan="6" style="text-align:center;">ƒêang t·∫£i...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="orderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="margin:0">Chi ti·∫øt ƒë∆°n h√†ng <span id="modalOrderId"></span></h3>
                <span style="cursor:pointer; font-size:1.5em;" onclick="closeModal()">&times;</span>
            </div>
            
            <div id="modalBody">
                </div>

            <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #ddd;">
                <label style="font-weight: bold;">C·∫≠p nh·∫≠t tr·∫°ng th√°i:</label>
                <select id="statusSelect" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;">
                    <option value="Pending">Pending (Ch·ªù x·ª≠ l√Ω)</option>
                    <option value="Processing">Processing (ƒêang ƒë√≥ng g√≥i)</option>
                    <option value="Shipped">Shipped (ƒêang giao h√†ng)</option>
                    <option value="Delivered">Delivered (Giao th√†nh c√¥ng)</option>
                    <option value="Cancelled">Cancelled (H·ªßy ƒë∆°n)</option>
                </select>
                <button class="btn-update" onclick="updateStatus()">C·∫≠p nh·∫≠t ngay</button>
            </div>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('adminToken');
        if (!token) window.location.href = 'login.html';

        let currentOrderId = null;

        async function loadOrders() {
            try {
                const res = await fetch('http://localhost:5000/api/orders', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const orders = await res.json();
                
                const tbody = document.getElementById('order-table-body');
                if (orders.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o</td></tr>';
                    return;
                }

                tbody.innerHTML = orders.map(order => {
                    let badgeClass = 'bg-pending';
                    if (order.status === 'Processing') badgeClass = 'bg-processing';
                    if (order.status === 'Shipped') badgeClass = 'bg-shipped';
                    if (order.status === 'Delivered') badgeClass = 'bg-delivered';
                    if (order.status === 'Cancelled') badgeClass = 'bg-cancelled';

                    return `
                        <tr>
                            <td>#${order._id.slice(-6).toUpperCase()}</td>
                            <td>
                                <div>${order.user ? order.user.name : 'Kh√°ch v√£ng lai'}</div>
                                <small style="color:#666">${order.user ? order.user.email : ''}</small>
                            </td>
                            <td>${new Date(order.createdAt).toLocaleDateString('vi-VN')}</td>
                            <td style="font-weight:bold; color:#d32f2f;">${Number(order.totalPrice).toLocaleString('vi-VN')} ƒë</td>
                            <td><span class="badge ${badgeClass}">${order.status || 'Pending'}</span></td>
                            <td>
                                <button onclick="openModal('${order._id}')" style="padding:5px 10px; border:1px solid #ddd; background:white; cursor:pointer; border-radius:4px;">üëÅÔ∏è Xem</button>
                            </td>
                        </tr>
                    `;
                }).join('');

            } catch (error) {
                console.error(error);
                alert('L·ªói t·∫£i danh s√°ch ƒë∆°n h√†ng');
            }
        }

        async function openModal(id) {
            currentOrderId = id;
            document.getElementById('orderModal').style.display = 'flex';
            document.getElementById('modalBody').innerHTML = '<p>ƒêang t·∫£i chi ti·∫øt...</p>';
            document.getElementById('modalOrderId').innerText = '#' + id.slice(-6).toUpperCase();

            try {
                const res = await fetch(`http://localhost:5000/api/orders/${id}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const order = await res.json();

                document.getElementById('statusSelect').value = order.status || 'Pending';

                const itemsHtml = order.orderItems.map(item => `
                    <div style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px dashed #eee;">
                        <div style="display:flex; gap:10px;">
                            <img src="${item.image}" width="50" height="50" style="object-fit:cover; border-radius:4px;">
                            <div>
                                <div>${item.name}</div>
                                <small>x ${item.qty}</small>
                            </div>
                        </div>
                        <div>${(item.qty * item.price).toLocaleString('vi-VN')} ƒë</div>
                    </div>
                `).join('');

                document.getElementById('modalBody').innerHTML = `
                    <div style="background:#f9f9f9; padding:10px; border-radius:4px; margin-bottom:10px;">
                        <strong>Ng∆∞·ªùi nh·∫≠n:</strong> ${order.shippingAddress.fullName}<br>
                        <strong>SƒêT:</strong> ${order.shippingAddress.phone}<br>
                        <strong>ƒê·ªãa ch·ªâ:</strong> ${order.shippingAddress.address}, ${order.shippingAddress.city}<br>
                        <strong>Thanh to√°n:</strong> ${order.paymentMethod} (${order.isPaid ? '<span style="color:green">ƒê√£ tr·∫£ ti·ªÅn</span>' : '<span style="color:red">Ch∆∞a tr·∫£ ti·ªÅn</span>'})
                    </div>
                    <h4>S·∫£n ph·∫©m:</h4>
                    ${itemsHtml}
                    <h3 style="text-align:right; color:#d32f2f; margin-top:10px;">T·ªïng: ${Number(order.totalPrice).toLocaleString('vi-VN')} ƒë</h3>
                `;

            } catch (error) {
                alert("L·ªói t·∫£i chi ti·∫øt ƒë∆°n h√†ng");
            }
        }

        async function updateStatus() {
            if (!confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën c·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë∆°n h√†ng n√†y?")) return;

            const newStatus = document.getElementById('statusSelect').value;
            const btn = document.querySelector('.btn-update');
            btn.innerText = "ƒêang l∆∞u...";
            btn.disabled = true;

            try {
                const res = await fetch(`http://localhost:5000/api/orders/${currentOrderId}/status`, {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ status: newStatus })
                });

                if (res.ok) {
                    alert("C·∫≠p nh·∫≠t th√†nh c√¥ng!");
                    closeModal();
                    loadOrders();
                } else {
                    alert("L·ªói c·∫≠p nh·∫≠t!");
                }
            } catch (error) {
                alert("L·ªói k·∫øt n·ªëi Server");
            } finally {
                btn.innerText = "C·∫≠p nh·∫≠t ngay";
                btn.disabled = false;
            }
        }

        function closeModal() {
            document.getElementById('orderModal').style.display = 'none';
        }

        function logout() {
            localStorage.removeItem('adminToken');
            window.location.href = 'login.html';
        }

        window.onclick = function(event) {
            const modal = document.getElementById('orderModal');
            if (event.target == modal) closeModal();
        }

        loadOrders();
    </script>
</body>
</html>