<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Sản phẩm - Admin</title>
    <style>
        body { margin: 0; font-family: Arial, sans-serif; display: flex; height: 100vh; background: #f4f6f9; }
        .sidebar { width: 250px; background: #343a40; color: white; display: flex; flex-direction: column; }
        .sidebar h2 { text-align: center; padding: 20px 0; margin: 0; background: #23272b; border-bottom: 1px solid #4f5962; }
        .menu { list-style: none; padding: 0; margin: 0; flex: 1; }
        .menu li { border-bottom: 1px solid #4f5962; }
        .menu a { display: block; padding: 15px 20px; color: #c2c7d0; text-decoration: none; transition: 0.3s; }
        .menu a:hover, .menu a.active { background: #007bff; color: white; }
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .content { padding: 30px; overflow-y: auto; flex: 1; }

        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #007bff; color: white; }
        tr:hover { background: #f1f1f1; }
        
        .btn-action { padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; color: white; margin-right: 5px; }
        .btn-edit { background: #ffc107; color: #333; }
        .btn-delete { background: #dc3545; }
        .btn-add { background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin-bottom: 20px; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2>MINI ADMIN</h2>
        <ul class="menu">
            <li><a href="index.html">Tổng quan</a></li>
            <li><a href="products.html" class="active">Quản lý Sản phẩm</a></li>
            <li><a href="orders.html">Quản lý Đơn hàng</a></li>
            <li><a href="users.html">Quản lý Người dùng</a></li>
        </ul>
        <div style="padding: 15px; text-align: center; cursor: pointer; background: #dc3545;" onclick="logout()">Đăng xuất</div>
    </div>

    <div class="main-content">
        <div class="content">
            <h2 style="margin-top: 0;">Danh sách sản phẩm</h2>
            
            <button class="btn-add" onclick="window.location.href='product-form.html'">+ Thêm sản phẩm mới</button>

            <table>
                <thead>
                    <tr>
                        <th>Ảnh</th>
                        <th>Tên sản phẩm</th>
                        <th>Giá</th>
                        <th>Kho</th>
                        <th>Thương hiệu</th>
                        <th>Hành động</th>
                    </tr>
                </thead>
                <tbody id="product-table-body">
                    <tr><td colspan="6" style="text-align:center;">Đang tải dữ liệu...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('adminToken');
        if (!token) window.location.href = 'login.html';

        async function loadProducts() {
            try {
                const res = await fetch('http://localhost:5000/api/products?limit=100'); 
                const data = await res.json();
                
                const tbody = document.getElementById('product-table-body');
                
                if (data.products.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Chưa có sản phẩm nào</td></tr>';
                    return;
                }

                tbody.innerHTML = data.products.map(p => `
                    <tr>
                        <td><img src="${p.images[0] || 'https://via.placeholder.com/50'}" width="50" height="50" style="object-fit:cover; border-radius:4px;"></td>
                        <td><strong>${p.name}</strong></td>
                        <td style="color:#d32f2f; font-weight:bold;">${Number(p.price).toLocaleString('vi-VN')} đ</td>
                        <td>${p.stock}</td>
                        <td>${p.brand}</td>
                        <td>
                            <button class="btn-action btn-edit" onclick="editProduct('${p._id}')">Sửa</button>
                            <button class="btn-action btn-delete" onclick="deleteProduct('${p._id}')">Xóa</button>
                        </td>
                    </tr>
                `).join('');

            } catch (error) {
                console.error(error);
                alert("Lỗi tải danh sách sản phẩm!");
            }
        }

        async function deleteProduct(id) {
            if (!confirm("Bạn chắc chắn muốn xóa sản phẩm này? Hành động này không thể hoàn tác!")) return;

            try {
                const res = await fetch(`http://localhost:5000/api/products/${id}`, {
                    method: 'DELETE',
                    headers: { 
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (res.ok) {
                    alert("Đã xóa thành công!");
                    loadProducts(); 
                } else {
                    const data = await res.json();
                    alert("Lỗi: " + data.message);
                }
            } catch (error) {
                alert("Lỗi kết nối Server");
            }
        }

        function editProduct(id) {
            window.location.href = `product-form.html?id=${id}`;
        }

        function logout() {
            localStorage.removeItem('adminToken');
            window.location.href = 'login.html';
        }

        loadProducts();
    </script>
</body>
</html>